<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.scau.mis.product.mapper.ISaleItemMapper">

    <!-- 【最终版本】定义一个唯一的、正确的 ResultMap -->
    <resultMap type="edu.scau.mis.product.domain.SaleItem" id="SaleItemResultMap">
        <!-- SaleItem 自身字段的映射 -->
        <id     property="saleItemId"   column="sale_item_id"   />
        <result property="saleId"       column="sale_id"        />
        <!-- 【关键修改】增加 saleNo 的映射 -->
        <result property="saleNo"       column="sale_no"        />
        <result property="productId"    column="product_id"     />
        <result property="quantity"     column="quantity"       />
        <result property="price"        column="sale_item_price"/>
        <result property="status"       column="status"         />
        <result property="delFlag"      column="del_flag"       />
        <result property="createBy"     column="create_by"      />
        <result property="createTime"   column="create_time"    />
        <result property="updateBy"     column="update_by"      />
        <result property="updateTime"   column="update_time"    />
        <!-- 来自 pos_product 表的扁平化字段 -->
        <result property="productSn"    column="product_sn"     />
        <result property="productName"  column="product_name"   />
    </resultMap>


    <sql id="selectPosSaleItemVo">
        SELECT
            si.sale_item_id,
            si.sale_id,
            si.product_id,
            si.quantity,
            si.price AS sale_item_price,
            si.status,
            si.del_flag,
            si.create_by,
            si.create_time,
            si.update_by,
            si.update_time,
            p.product_sn,
            p.product_name,

            -- 【关键修改】从 pos_sale 表中查询出 sale_no
            s.sale_no
        FROM
            pos_sale_item si
                LEFT JOIN
            pos_product p ON p.product_id = si.product_id
                -- 【关键修改】增加与 pos_sale 表的连接
                LEFT JOIN
            pos_sale s ON s.sale_id = si.sale_id
    </sql>


    <!--根据id查询订单明细对象-->
    <select id="selectSaleItemById" parameterType="Long" resultMap="SaleItemResultMap">
        <include refid="selectPosSaleItemVo"/>
        WHERE si.sale_item_id = #{saleItemId}
    </select>

    <!--查询订单明细列表-->
    <select id="selectSaleItemList" parameterType="edu.scau.mis.product.domain.SaleItem" resultMap="SaleItemResultMap">
        <include refid="selectPosSaleItemVo"/>
        <where>
            <if test="saleItemId != null"> and si.sale_item_id = #{saleItemId}</if>
            <if test="saleId != null"> and si.sale_id = #{saleId}</if>
            <if test="productId != null"> and si.product_id = #{productId}</if>
        </where>
    </select>

    <!-- 让 selectSaleItemsBySaleId 查询也使用这个公共的 SQL 片段和 ResultMap -->
    <select id="selectSaleItemsBySaleId" parameterType="Long" resultMap="SaleItemResultMap">
        <include refid="selectPosSaleItemVo"/>
        WHERE si.sale_id = #{saleId}
    </select>

    <!--  批量新增订单明细  -->
    <insert id="batchInsertSaleItemOfCurrentSale" parameterType="java.util.List">
        INSERT INTO pos_sale_item(
        sale_id, product_id, product_sn, product_name, price,
        quantity, status, del_flag, create_by, create_time, update_by, update_time
        )
        VALUES
        <foreach item="item" index="index" collection="list" separator=",">
            (
            #{item.saleId}, #{item.productId}, #{item.productSn}, #{item.productName}, #{item.price},
            #{item.quantity}, #{item.status}, #{item.delFlag}, #{item.createBy}, #{item.createTime},
            #{item.updateBy}, #{item.updateTime}
            )
        </foreach>
    </insert>

    <!-- 其他 insert/update/delete 方法保持不变... -->
    <update id="updateStatusBySaleId">
        UPDATE pos_sale_item
        SET
            status = #{status},
            update_by = #{updateBy},
            update_time = #{updateTime}
        WHERE
            sale_id = #{saleId}
    </update>

</mapper>
